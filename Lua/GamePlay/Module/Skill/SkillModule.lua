---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by hao.wu.ss
--- DateTime: 2023/8/8 15:47
---

local BaseModule = require('BaseModule')
local ModuleRefer = require("ModuleRefer")
local ConfigRefer = require("ConfigRefer")

---@class SkillModule
local SkillModule = class('SkillModule', BaseModule)

function SkillModule:ctor()
	self._skillLevelUpCache = nil
end

function SkillModule:OnRegister()
	self:BuildSkillLevelUpCache()
end

function SkillModule:OnRemove()
    
end

function SkillModule:BuildSkillLevelUpCache()
	self._skillLevelUpCache = {}
	for _, cell in ConfigRefer.SkillLevelUp:ipairs() do
		local initId = cell:InitialSkillId()
		if (not self._skillLevelUpCache[initId]) then
			self._skillLevelUpCache[initId] = {}
		end
		self._skillLevelUpCache[initId][cell:SkillLevel()] = cell:FinalSkillId()
	end
end

--- 获取技能升级后对应的技能ID
---@param self SkillModule
---@param skillId number 技能ID
---@param level number 等级
---@return number
function SkillModule:GetSkillLevelUpId(skillId, level)
	if (not self._skillLevelUpCache) then
		self:BuildSkillLevelUpCache()
	end
	if (not self._skillLevelUpCache[skillId]) then return skillId end
	return self._skillLevelUpCache[skillId][level] or skillId
end

--- 获取SOC技能首个显示的属性
---@param self SkillModule
---@param skillLevel number
---@param skillId number
---@return number, string, string, boolean 数值, 显示名称, 格式化后的数值, 是否显示
function SkillModule:GetFirstShowCitizenSkillAttr(skillId, skillLevel)
	if (not skillLevel or skillLevel < 1) then skillLevel = 1 end
	local cfg = ConfigRefer.CitizenSkillInfo:Find(self:GetSkillLevelUpId(skillId, skillLevel))
	if (not cfg) then return end
	local attrList = ModuleRefer.AttrModule:CalcAttrGroupByTemplateId(cfg:AttrTemplateCfg(), skillLevel)
	for i = 1, cfg:CitizenAttrDisplayLength() do
		local attrId = cfg:CitizenAttrDisplay(i)
		local dispConf = ConfigRefer.AttrDisplay:Find(attrId)
		if (dispConf) then
			local value, desc, formattedValue, show = ModuleRefer.AttrModule:GetDisplayValueWithData(dispConf, attrList)
			if (show) then
				return value, desc, formattedValue, show
			end
		end
	end
end

return SkillModule
