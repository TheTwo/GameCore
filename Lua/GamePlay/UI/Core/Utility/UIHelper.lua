---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by shoufeng.zhang.
--- DateTime: 2022/4/20 19:10
---
local UIHelper = class("UIHelper")
local CSHelper = CS.DragonReborn.UI.UIHelper
local LuaHelper = CS.DragonReborn.UI.LuaUIUtility
local ArtResourceUtils = require("ArtResourceUtils")
local GuideAnchorType = require('GuideAnchorType')
local Utils = require('Utils')
local CommonConfirmPopupMediatorDefine = require("CommonConfirmPopupMediatorDefine")
local UIMediatorNames = require("UIMediatorNames")
local I18N = require("I18N")
local ModuleRefer = require("ModuleRefer")

local Vector2 = CS.UnityEngine.Vector2

local MIN_HERO_ICON_SIZE = 48
local MAX_HERO_ICON_SIZE = 296
local MIN_ICON_SIZE = 64
local MID_ICON_SIZE = 152


function UIHelper.GetColoredText(text,colorStr)
    return string.format("<color=%s>%s</color>", colorStr, text);
end

function UIHelper.GetSizeText(text,size)
    return string.format("<size=%s>%s</size>", size, text);
end

function UIHelper.GetSizeAndColorText(text,size,colorStr)
    return string.format("<color=%s><size=%s>%s</size></color>", colorStr, size, text);
end

function UIHelper.GetColoredTextRGBA(text,R,G,B,A)
    return string.format("<color=#%02x%02x%02x%02x>%s</color>", R,G,B,A, text);
end

---@return CS.UnityEngine.Color
function UIHelper.TryParseHtmlString(htmlString)
   local _, color = CS.UnityEngine.ColorUtility.TryParseHtmlString(htmlString)
   return color
end

function UIHelper.CreateUIComponent(path,parent,callback)
    if string.IsNullOrEmpty(path)
        or parent == nil
    then
        if callback ~= nil then
            callback(nil)
        end
        return
    end
    CSHelper.CreateUIComponent(path,parent,callback)
end

function UIHelper.SetUIComponentParent(CSComponent, parent,param)
    if CSComponent == nil or parent == nil then
        return
    end
    CSHelper.SetUIComponentParent(CSComponent, parent,param)
end

---复制一个UI节点，如果newParent为空，复制出来的节点自动挂在uiComponent的父节点下
---@generic T : CS.DragonReborn.UI.BaseComponent
---@param uiComponent T
---@param newParent CS.UnityEngine.Transform
---@return T
function UIHelper.DuplicateUIComponent(uiComponent,newParent,param)
    if uiComponent == nil then
        return
    end
    return CSHelper.DuplicateUIComponent(uiComponent,newParent,param)
end

---删除一个UI节点，处理完Componet之后，直接删除GameObject
---@param uiComponent CS.DragonReborn.UI.BaseComponent
function UIHelper.DeleteUIComponent(uiComponent,param)
    if uiComponent == nil then
        return
    end
    return CSHelper.DeleteComponent(uiComponent,param)
end

function UIHelper.DisableUIComponent(go)
    local comps = go:GetComponentsInChildren(typeof(CS.DragonReborn.UI.BaseComponent))
    if comps and comps.Length > 0 then
        for i = 0, comps.Length - 1 do
            comps[i].enabled = false
        end
    end
end

---@param uiGo CS.UnityEngine.GameObject
---@return CS.UnityEngine.GameObject
function UIHelper.DuplicateUIGameObject(uiGo,newParent)
    if uiGo == nil then return end
    return CSHelper.DuplicateUIGameObject(uiGo,newParent)
end

function UIHelper.DeleteUIGameObject(uiGo)
    if Utils.IsNull(uiGo) then return end
    ---@type CS.UnityEngine.Object
    local obj = CS.UnityEngine.Object
    obj.Destroy(uiGo)
end

function UIHelper.LoadSprite(name,image)
    if string.IsNullOrEmpty(name) or Utils.IsNull(image) then
        return
    end
    g_Game.SpriteManager:LoadSprite(name,image)
end

function UIHelper.AddUIComponent(path,go)
    if string.IsNullOrEmpty(path) or go == nil then
        return nil
    end
    return LuaHelper.AddLuaComponent(path,go)
end

function UIHelper.SetUIComponentVisible(comp, visible)
    if comp == nil or comp.CSComponent == nil then
        return
    end
    if visible == nil then
        visible = true
    end
    comp.CSComponent.gameObject:SetActive(visible)
end

function UIHelper.SetGray(go,isGray)
    CSHelper.SetGray(go,isGray)
end

function UIHelper.ButtonEnable(button,enable)
    CSHelper.ButtonEnable(button,enable)
end

function UIHelper.ResetContent(go)
    CSHelper.ResetContentLayout(go)
end

function UIHelper.DestroyAllTableViewCachedObjects()
    CSHelper.DestroyAllTableViewCachedObjects()
end

---@param timeout number
---@param timeoutCallback fun()
function UIHelper.AddFullScreenLock(timeout,timeoutCallback)
    CS.DragonReborn.UI.UILocker.AddFullScreenLock(timeout,timeoutCallback)
end

function UIHelper.RemoveFullScreenLock()
    CS.DragonReborn.UI.UILocker.RemoveFullScreenLock()
end

---@class UILockData
---@field trans CS.UnityEngine.Transform[]
---@field fullScreen boolean
---@field fullScreenPosInView CS.UnityEngine.Vector2|nil

---@param lockable UILockData
function UIHelper.UILock(lockable)
    if not lockable then
        return
    end
    if not lockable.fullScreen and lockable.trans and #lockable.trans > 0 then
        CS.DragonReborn.UI.UILocker.DoLock(lockable.trans)
    elseif  lockable.fullScreen then
        CS.DragonReborn.UI.UILocker.DoLock(nil, lockable.fullScreenPosInView)
    end
end

---@param lockable UILockData
function UIHelper.UIUnlock(lockable)
    if not lockable then
        return
    end
    if not lockable.fullScreen and lockable.trans and #lockable.trans > 0 then
        CS.DragonReborn.UI.UILocker.DoUnlock(lockable.trans)
    elseif lockable.fullScreen then
        CS.DragonReborn.UI.UILocker.DoUnlock(nil)
    end
end

function UIHelper.FullScreenLock(timeout,timeoutCallback)
    timeout = timeout or 5
    CS.DragonReborn.UI.UILocker.AddFullScreenLock(timeout, timeoutCallback)
end

function UIHelper.RemoveFullScreenLock()
    CS.DragonReborn.UI.UILocker.RemoveFullScreenLock()
end

---世界坐标转换到UI坐标
---@param worldCam CS.UnityEngine.Camera @3D摄像机
---@param worldPos CS.UnityEngine.Vector3 @世界坐标
---@param parent CS.UnityEngine.Transform @UI父结点,默认为UIRoot
function UIHelper.WorldPos2UIPos(worldCam,worldPos,parent)
   return CSHelper.WorldPos2UIPos(worldCam,worldPos,parent)
end

---锚定UI到一个世界空间中的位置
---@param worldCam CS.UnityEngine.Camera @3D摄像机
---@param uiTrans CS.UnityEngine.Transform @UI父结点
---@param posWS CS.UnityEngine.Vector3 @锚点的世界坐标
function UIHelper.SetWSPosAnchor(worldCam, uiTrans, posWS)
    CSHelper.SetWSPosAnchor(worldCam, uiTrans, posWS)
end

---锚定UI到一个世界空间中的Transform
---@param worldCam CS.UnityEngine.Camera @3D摄像机
---@param uiTrans CS.UnityEngine.Transform @UI父结点
---@param transWS CS.UnityEngine.Transform @锚点
---@return CS.DragonReborn.UI.UIWSPosAnchor
function UIHelper.SetWSTransAnchor(worldCam, uiTrans, transWS,keepOnBoard,visibleCallback)
    keepOnBoard = keepOnBoard or false
    return CSHelper.SetWSTransAnchor(worldCam, uiTrans, transWS,keepOnBoard,visibleCallback)
end
---锚定UI方向到一个世界空间中的Transform
---@param worldCam CS.UnityEngine.Camera @3D摄像机
---@param uiTrans CS.UnityEngine.Transform @UI父结点
---@param transWS CS.UnityEngine.Transform @锚点
---@return CS.DragonReborn.UI.UILookAtAnchor
function UIHelper.SetWSLookAtAnchor(worldCam, uiTrans, transWS,revertDir)
    revertDir = revertDir or false
    return CSHelper.SetWSLookAtAnchor(worldCam, uiTrans, transWS,revertDir)
end

function UIHelper.SetOtherUIAnchor(uiTrans,otherUI,offset)
    return CSHelper.SetOtherUIAnchor(uiTrans,otherUI,offset)
end

---@param screenPos CS.UnityEngine.Vector2
---@return CS.UnityEngine.Vector3
function UIHelper.ScreenPos2UIPos(screenPos)
    return CSHelper.ScreenPos2UIPos(screenPos)
end
function UIHelper.UIPos2ScreenPos(uiPos)
    return CSHelper.UIPos2ScreenPos(uiPos)
end

function UIHelper.XY2UIPos(x,y)
    return CSHelper.ScreenPos2UIPos(CS.UnityEngine.Vector2(x,y))
end


---@param type GuideAnchorType
---@return CS.UnityEngine.Vector2,CS.UnityEngine.Vector2 @AnchorMin,AnchorMax
function UIHelper.GetAnchorValue(type)
    if type == GuideAnchorType.Top then
        return Vector2(0.5,1),Vector2(0.5,1)
    elseif type == GuideAnchorType.Bottom then
        return Vector2(0.5,0),Vector2(0.5,0)
    elseif type == GuideAnchorType.Left then
        return Vector2(0,0.5),Vector2(0,0.5)
    elseif type == GuideAnchorType.Right then
        return Vector2(1,0.5),Vector2(1,0.5)
    elseif type == GuideAnchorType.LeftTop then
        return Vector2(0,1),Vector2(0,1)
    elseif type == GuideAnchorType.RightTop then
        return Vector2(1,1),Vector2(1,1)
    elseif type == GuideAnchorType.LeftBottom then
        return Vector2(0,0),Vector2(0,0)
    elseif type == GuideAnchorType.RightBottom then
        return Vector2(1,0),Vector2(1,0)
    else
        --center
        return Vector2(0.5,0.5),Vector2(0.5,0.5)
    end
end

function UIHelper.SetLayer(go,layer)
    if Utils.IsNull(go) or layer < 0 then
        return
    end
    CSHelper.SetLayer(go,layer)
end

function UIHelper.ShowDropDownBlockMask(go,blockGo)
    return CSHelper.ShowDropDownBlockMask(go,blockGo)
end

function UIHelper.HideDropDownBlockMask(go,blockGo)
    return CSHelper.HideDropDownBlockMask(go,blockGo)
end

function UIHelper.ShowConfirm(content, title, confirm, cancel, confirmLabel, cancelLabel)
    ---@type CommonConfirmPopupMediatorParameter
    local dialogParam = {}
    dialogParam.styleBitMask = CommonConfirmPopupMediatorDefine.Style.ConfirmAndCancel | CommonConfirmPopupMediatorDefine.Style.ExitBtn
    if not title then
        title = I18N.Get("citizen_check_in_hint_title")
    end
    dialogParam.title = title
    dialogParam.content = content
    dialogParam.confirmLabel = confirmLabel
    dialogParam.cancelLabel = cancelLabel
    dialogParam.onConfirm = function(context)
        if confirm then confirm() end
        return true
    end
    dialogParam.onCancel = function(context)
        if cancel then cancel() end
        return true
    end
    g_Game.UIManager:Open(UIMediatorNames.CommonConfirmPopupMediator, dialogParam, nil, true)
end

function UIHelper.IconOrMissing(iconAsset)
    if string.IsNullOrEmpty(iconAsset) then
        return "sp_icon_missing"
    else
        return iconAsset
    end
end

function UIHelper.DisableUIInputs()
	local uiRoot = g_Game.UIManager:GetUIRoot()
	if (Utils.IsNotNull(uiRoot)) then
		---@type CS.UnityEngine.CanvasGroup
		local canvasGroup = uiRoot:GetComponent(typeof(CS.UnityEngine.CanvasGroup))
		if (canvasGroup) then
			canvasGroup.interactable = false
		end
	end
end

function UIHelper.EnableUIInputs()
	local uiRoot = g_Game.UIManager:GetUIRoot()
	if (Utils.IsNotNull(uiRoot)) then
		---@type CS.UnityEngine.CanvasGroup
		local canvasGroup = uiRoot:GetComponent(typeof(CS.UnityEngine.CanvasGroup))
		if (canvasGroup) then
			canvasGroup.interactable = true
		end
	end
end

function UIHelper.ShowRewardPreview(itemGroupId, trans)
    local items = ModuleRefer.InventoryModule:ItemGroupId2ItemArrays(itemGroupId)
    local rewardLists = {{titleText = I18N.Get('leaderboard_info_8')}}
    for _, item in ipairs(items) do
        rewardLists[#rewardLists + 1] = {itemId = item.configCell:Id(), itemCount = item.count}
    end
    local giftTipsParam =
    {
        listInfo = rewardLists,
        clickTrans = trans
    }
    g_Game.UIManager:Open(UIMediatorNames.GiftTipsUIMediator, giftTipsParam)
end

--文本结尾以省略号结尾 （...）
function UIHelper.SetStringEllipsis(textComponent, str)
    local count =  textComponent.cachedTextGenerator.characterCountVisible
    local res = str
    if(#str > count) then
        res = UIHelper.Sub(str, 1,count-3)
        res = res .. "..."
    end

    textComponent.text = res
end

function UIHelper.Ellipsis(textComponent, input)
    --local input = "This<b><color=#0000ffff>bold</color>a</b>and<color=#0000ffff>italic</color>text."
    local pattern1 = "<.->"
    local no_tags = string.gsub(input, pattern1, "")
    textComponent.text = no_tags
    CS.UnityEngine.Canvas.ForceUpdateCanvases()
    local subIndex = textComponent.cachedTextGenerator.characterCountVisible - 1
    local startIndex = utf8.offset(input, subIndex)
    local pattern = "()<(.-)>()"
    local offsets = {}
    for start_tag, match, end_tag in string.gmatch(input, pattern) do
        offsets[#offsets + 1] = {start_tag, match, end_tag}
    end
    local resultIndex = startIndex
    local insertTag = {}
    for index, offset in ipairs(offsets) do
        if resultIndex >= offset[1] then
            resultIndex = resultIndex + offset[3] - offset[1]
            insertTag[#insertTag + 1] = {offset[1], offset[2]}
        else
            insertTag[#insertTag + 1] = {-1, offset[2]}
            local nextTag = offsets[index + 1]
            if nextTag and not string.find(nextTag[2], "/") then
                break
            end
        end
    end
    local sub = string.sub(no_tags, 1, utf8.offset(no_tags, subIndex + 1) - 1)
    for _, insert in ipairs(insertTag) do
        local index = insert[1]
        if index > 0 then
            sub = string.sub(sub, 1, index - 1) .. '<' .. insert[2] .. '>' .. string.sub(sub, index)
        else
            if string.find(insert[2], "/") then
                sub = sub .. '<' .. insert[2] .. '>'
            end
        end
    end
    textComponent.text = sub .. "..."
end

--多语言Substring
function UIHelper.Sub(str, startIndex, endIndex)
   local tempStr = str
   local byteStart = 1
   local byteEnd = -1
   local index = 0
   local bytes = 0

   startIndex = math.max(startIndex, 1)
   endIndex = endIndex or -1
   while string.len(tempStr) > 0 do
      if index == startIndex - 1 then
         byteStart = bytes+1;
      elseif index == endIndex then
         byteEnd = bytes;
         break;
      end
      bytes = bytes + UIHelper.GetBytes(tempStr)
      tempStr = string.sub(str, bytes+1)

      index = index + 1
   end
   return string.sub(str, byteStart, byteEnd)
end

--[[
utf-8编码规则
单字节 - 0起头
   1字节  0xxxxxxx   0 - 127
多字节 - 第一个字节n个1加1个0起头
   2 字节 110xxxxx   192 - 223
   3 字节 1110xxxx   224 - 239
   4 字节 11110xxx   240 - 247
可能有1-4个字节
--]]
function UIHelper.GetBytes(char)
   if not char then
      return 0
   end
   local code = string.byte(char)
   if code < 127 then
      return 1
   elseif code <= 223 then
      return 2
   elseif code <= 239 then
      return 3
   else
      return 4
   end
end

---@param rank number
---@return string or nil
function UIHelper.GetRankIcon(rank)
    if rank == 1 then return 'sp_activity_ranking_icon_top_1' end
    if rank == 2 then return 'sp_activity_ranking_icon_top_2' end
    if rank == 3 then return 'sp_activity_ranking_icon_top_3' end
    return nil
end

---@param creater CS.DragonReborn.AssetTool.GameObjectCreateHelper
---@param goParent CS.UnityEngine.Transform
---@param spineCell ArtResourceUIConfigCell
---@param receiver fun(go:CS.UnityEngine.GameObject)
---@param overrideCallback fun(go:CS.UnityEngine.GameObject)
function UIHelper.SimpleCreateSpine(creater, goParent, spineCell, receiver, overrideCallback)
    if not creater or Utils.IsNull(goParent) or not spineCell then
        return
    end
    local assetPath = spineCell:Path()
    local callback = overrideCallback or function(go)
        if Utils.IsNull(go) then
            return
        end
        local pivot = CS.UnityEngine.Vector2(0.5, 0.5)
        if spineCell:SpinePivotLength() > 1 then
            pivot = CS.UnityEngine.Vector2(spineCell:SpinePivot(1), spineCell:SpinePivot(2))
        end
        local localScale = CS.UnityEngine.Vector3.one
        if spineCell:SpineScaleLength() > 1 then
            localScale = CS.UnityEngine.Vector3(spineCell:SpineScale(1), spineCell:SpineScale(2), 1)
        end
        local rectTrans = go:GetComponent(typeof(CS.UnityEngine.RectTransform))
        if Utils.IsNotNull(rectTrans) then
            rectTrans.pivot = pivot
            rectTrans.localScale = localScale
        else
            local trans = go.transform
            trans.localScale = localScale
        end
        if receiver then
            receiver(go)
        end
    end
    creater:Create(assetPath, goParent, callback)
end

---@param image CS.UnityEngine.UI.Image
---@param itemConfig ItemConfigCell
---@return string or nil
function UIHelper.GetFitItemIcon(image, itemConfig)
    if image.rectTransform.rect.width <= MIN_ICON_SIZE then
        local subIcon = itemConfig:SubIcon()
        if not string.IsNullOrEmpty(subIcon) then
            return subIcon
        end
    end
    return itemConfig:Icon()
end

---@param image CS.UnityEngine.UI.Image
---@param heroClientRes HeroClientResConfigCell
---@return string or nil
function UIHelper.GetFitHeroHeadIcon(image, heroClientRes)
    local width = image.rectTransform.rect.width
    if width <= MIN_HERO_ICON_SIZE then
        local miniS = heroClientRes:HeadMiniS()
        if not string.IsNullOrEmpty(miniS) then
            return miniS
        end
    end
    if width > MAX_HERO_ICON_SIZE  then
        local miniL = heroClientRes:HeadMiniL()
        if not string.IsNullOrEmpty(miniL) then
            return miniL
        end
    end
    return heroClientRes:HeadMini()
end

---@param image CS.UnityEngine.UI.Image
---@param petCfg PetConfigCell
---@return string or nil
function UIHelper.GetFitPetHeadIcon(image, petCfg)
    local width = image.rectTransform.rect.width
    if width <= MIN_ICON_SIZE then
        local minIcon = petCfg:TinyIcon()
        if minIcon and minIcon > 0 then
            return ArtResourceUtils.GetUIItem(minIcon)
        end
    end
    return ArtResourceUtils.GetUIItem(petCfg:Icon())
end

---@param image CS.UnityEngine.UI.Image
function UIHelper.CalcFullFitImageSize(image)
    if Utils.IsNull(image) or Utils.IsNull(image.sprite) then
        return
    end
    local spRect = image.sprite.rect
    UIHelper.ResizeFullFitImageSize(image,spRect.width,spRect.height)
end

---@param image CS.UnityEngine.UI.Image
function UIHelper.ResizeFullFitImageSize(image,oriWidth,oriHeight)
    if Utils.IsNull(image)  then
        return
    end    
    local spAspect = oriWidth / oriHeight
    
    local uiRoot = g_Game.UIManager:GetUIRoot()
    local uiRootRect = uiRoot:GetComponent(typeof(CS.UnityEngine.RectTransform))
    local uiRootWidth = uiRootRect.rect.width
    local uiRootHeight = uiRootRect.rect.height
    local rootAspect = uiRootWidth / uiRootHeight

    local width,height

    if rootAspect > spAspect then
        width = uiRootWidth
        height = width / spAspect
    else
        height = uiRootHeight
        width = height * spAspect
    end
   
    image.rectTransform.sizeDelta = CS.UnityEngine.Vector2(width, height)
end

return UIHelper;
