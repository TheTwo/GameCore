---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by shoufeng.zhang.
--- DateTime: 2022/4/28 19:57
---
local KingdomScene = require('KingdomScene')
local SeScene = require('SeScene')
local SeJumpScene = require('SeJumpScene')
local SlgScene = require('SlgScene')
local NewbieScene = require("NewbieScene")
local RogueSEScene = require("RogueSEScene")
local SeState = require('SeState')
local SlgState = require('SlgState')
local NewbieState = require("NewbieState")
local KingdomState = require('KingdomState')
local RogueSEState = require("RogueSEState")
local ModuleRefer = require('ModuleRefer')
local EventConst = require('EventConst')
local NativeLoadingOverlay = require('NativeLoadingOverlay')

---@class Initialization
local Initialization = {}

function Initialization.OnGameBoot()
    g_Game.ModuleManager:RetrieveModule('HotfixModule')
end

function Initialization.OnLoggedIn()
    g_Game.IOAccessRecorder.StartStep("Initialization:OnLoggedIn")
    local enterSceneModule = ModuleRefer.EnterSceneModule
    enterSceneModule:SetSceneSystemReady(true)

    ModuleRefer.PerformanceModule:OnLoggedIn()
    ModuleRefer.FPXSDKModule:OnLoggedIn()
    ModuleRefer.CityCitizenModule:OnLoggedIn()
    ModuleRefer.CityModule:OnLoggedIn()
    ModuleRefer.AllianceModule:DoUpdateAllianceId()
	ModuleRefer.AllianceJourneyModule:SetUp()
    ModuleRefer.CityOnlineRewardModule:OnLoggedIn()

	-- 0.9.0 版本移除捉宠 timeline 预创建
    --ModuleRefer.PetCaptureModule:LoadTimelines()
    ModuleRefer.LandformModule:Initialize()
    ModuleRefer.ChatSDKModule:InitSdk()
    ModuleRefer.GuideModule.new()
    ModuleRefer.PetModule:SetUp()

    if not enterSceneModule:IsRequesting() then
        --enterSceneModule:DoShaderWarmup("shader_city")
        --enterSceneModule:DoShaderWarmup("shader_variants_warm_up")
        --enterSceneModule:DoEnterScene()
        g_Game.EventManager:AddListener(EventConst.SCENE_LOADED, Initialization.OnSceneLoaded)
        enterSceneModule:DoShaderWarmupAsync("shader_variants_warm_up", true)
    end

    if ModuleRefer.RadarModule:CheckIsUnlockRadar() then
        --enterSceneModule:DoShaderWarmup("shader_kingdom")
        CS.DragonReborn.AssetTool.ShaderWarmupUtils.WarmUpShaderVariantsAsync("shader_kingdom", 10)
    end
end

function Initialization.OnSceneLoaded()
    g_Game.IOAccessRecorder.StartStep("Initialization:OnSceneLoaded")
    g_Game.UIManager:CloseByName("UIGameLaunchMediator")
    g_Game.EventManager:RemoveListener(EventConst.SCENE_LOADED, Initialization.OnSceneLoaded)
    NativeLoadingOverlay.CheckAndWriteOverrideIcon()
end

--- Lua资源已更新的回调，业务入口，此时配置尚未更新完毕，如业务与配置有关，则最好在OnLoggedIn阶段
function Initialization.PostSyncAssetBundle()
    require("CityConst").OnConfigLoaded()
    require("TouchInfoDefine").OnConfigLoaded()
    require("CircleMenuButtonConfig").OnConfigLoaded()
    require("CityCreepManager").OnConfigLoaded()

    ModuleRefer.PlayerModule:InitExpTable()

    -- 初始化状态机
    g_Game.StateMachine:AddState(KingdomState.Name, KingdomState.new())
    g_Game.StateMachine:AddState(SeState.Name, SeState.new())
    g_Game.StateMachine:AddState(SlgState.Name, SlgState.new())
    g_Game.StateMachine:AddState(NewbieState.Name, NewbieState.new())
    g_Game.StateMachine:AddState(RogueSEState.Name, RogueSEState.new())

    -- 初始化场景
    g_Game.SceneManager:AddScene(KingdomScene.Name, KingdomScene.new())
    g_Game.SceneManager:AddScene(SeScene.Name, SeScene.new())
    g_Game.SceneManager:AddScene(SeJumpScene.Name, SeJumpScene.new())
    g_Game.SceneManager:AddScene(SlgScene.Name, SlgScene.new())
    g_Game.SceneManager:AddScene(NewbieScene.Name, NewbieScene.new())
    g_Game.SceneManager:AddScene(RogueSEScene.Name, RogueSEScene.new())
end

return Initialization
