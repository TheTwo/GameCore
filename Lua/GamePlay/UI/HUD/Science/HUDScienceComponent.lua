---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by shoufeng.zhang.
--- DateTime: 2022/5/16 17:10
---
local BaseUIComponent = require('BaseUIComponent')
local ModuleRefer = require('ModuleRefer')
local Delegate = require('Delegate')
local ConfigRefer = require('ConfigRefer')
local EventConst = require('EventConst')
---@class HUDScienceComponent : BaseUIComponent
local HUDScienceComponent = class("HUDScienceComponent",BaseUIComponent)

---@protected
function HUDScienceComponent:ctor(...)
    BaseUIComponent.ctor(self, ...)
end

function HUDScienceComponent:OnCreate(param)
    self.btnDetail = self:Button('p_btn_science', Delegate.GetOrCreate(self, self.OnBtnClicked))
    self.goStateFree = self:GameObject('child_status_free')
    self.goTime = self:GameObject('p_time')
    self.childTime = self:LuaObject("child_time")
 end

function HUDScienceComponent:OnShow(param)
    g_Game.EventManager:AddListener(EventConst.ON_REFRESH_TECH, Delegate.GetOrCreate(self, self.OnChangeTechState))
    g_Game.EventManager:AddListener(EventConst.QUEST_DATA_WATCHER_EVENT, Delegate.GetOrCreate(self,self.OnUserQuestDatabaseChanged))
    g_Game.EventManager:AddListener(EventConst.CITY_SET_ACTIVE, Delegate.GetOrCreate(self,self.OnUserQuestDatabaseChanged))
    self:OnUserQuestDatabaseChanged()
end

function HUDScienceComponent:OnHide(param)
    g_Game.EventManager:RemoveListener(EventConst.ON_REFRESH_TECH, Delegate.GetOrCreate(self, self.OnChangeTechState))
    g_Game.EventManager:RemoveListener(EventConst.QUEST_DATA_WATCHER_EVENT, Delegate.GetOrCreate(self,self.OnUserQuestDatabaseChanged))
    g_Game.EventManager:RemoveListener(EventConst.CITY_SET_ACTIVE, Delegate.GetOrCreate(self,self.OnUserQuestDatabaseChanged))
end

function HUDScienceComponent:OnBtnClicked()
    g_Game.UIManager:Open('UIScienceMediator')
end

function HUDScienceComponent:OnUserQuestDatabaseChanged()
    local isFinish = self:CheckIsShow()
    self.btnDetail.gameObject:SetActive(isFinish)
    self:OnChangeTechState()
end

function HUDScienceComponent:CheckIsShow()
    local sysIndex = ConfigRefer.ConstMain:ScienceSystemSwitch()
    -- local taskState = ModuleRefer.QuestModule:GetQuestFinishedStateLocalCache(taskId)
    -- local isFinish = taskState == wds.TaskState.TaskStateFinished
    return ModuleRefer.NewFunctionUnlockModule:CheckNewFunctionIsUnlocked(sysIndex)
end

function HUDScienceComponent:OnChangeTechState()
    local isFinish = self:CheckIsShow()
    local isShow = isFinish and ModuleRefer.ScienceModule:CheckIsHasCanResearchTech()
    self.goStateFree:SetActive(isShow)
    self.goTime:SetActive(not isShow)
    if isFinish and not isShow then
        if ModuleRefer.ScienceModule:GetCurResearchingTech() > 0 then
            self.goTime:SetActive(true)
            local finishTime = ModuleRefer.ScienceModule:GetCurResearchingTechFinishTime()
            local timerData = {}
            timerData.endTime = finishTime
            timerData.needTimer = true
            self.childTime:FeedData(timerData)
        else
            self.goTime:SetActive(false)
        end
    end
end

return HUDScienceComponent