---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by shoufeng.zhang.
--- DateTime: 2022/6/13 18:55
---
local CameraUtils = require("CameraUtils")
local FpAnimTriggerEvent = require('FpAnimTriggerEvent')
---@class UIMediatorCommonProcessor
local UIMediatorCommonProcessor = class('UIMediatorCommonProcessor')

---PreProcessOnHide
---@param uiMediator CS.DragonReborn.UI.UIMediator
function UIMediatorCommonProcessor:PreProcessOnHide(uiMediator)
    if uiMediator and uiMediator.Property.CullScene then
        local cullCount = g_Game.UIManager:CullSceneUIMediatorCount();
        if cullCount <= 0 then
            CS.ClearCamera.ShowSceneCamera()
        end
    end
    self:RefreshBlockStatus()

     --如果关闭的是全屏PopupUI，需要打开窗口之后的Canvas
    if (uiMediator.Property.Type == CS.DragonReborn.UI.UIMediatorType.Popup and uiMediator.Property.UseZBlur ) then
        g_Game.UIManager:SetVisibleByType(CS.DragonReborn.UI.UIMediatorType.Dialog, true)        
    end
    if uiMediator.Lua and uiMediator.Lua.needRecoverUI3DRoot then
        g_Game.UIManager.ui3DViewManager:Enable()
        uiMediator.Lua.needRecoverUI3DRoot = nil
    end
end

---PostProcessOnShow
---@param uiMediator CS.DragonReborn.UI.LuaUIMediator
function UIMediatorCommonProcessor:PostProcessOnShow(uiMediator)
    local haveCull = g_Game.UIManager:HaveCullSceneUIMediator();
    if haveCull and not g_Game.UIManager.ui3DViewManager:IsEnabled() then
        CS.ClearCamera.HideSceneCamera()
    end
    self:RefreshBlockStatus()

    --如果弹出的是全屏PopupUI，需要关闭窗口之后的Canvas
    if (uiMediator.Property.Type == CS.DragonReborn.UI.UIMediatorType.Popup and uiMediator.Property.UseZBlur ) then
        g_Game.UIManager:SetVisibleByType(CS.DragonReborn.UI.UIMediatorType.Dialog, false)
        if g_Game.UIManager.ui3DViewManager:IsEnabled() then
            if uiMediator.Lua then
                uiMediator.Lua.needRecoverUI3DRoot = true
                g_Game.UIManager.ui3DViewManager:Disable()
            end
        end
    end

end
---@param uiMediator CS.DragonReborn.UI.UIMediator
---@param skipShowAni boolean
function UIMediatorCommonProcessor:PreProcessOnShow(uiMediator, skipShowAni)
    uiMediator:TriggerAllAnim(FpAnimTriggerEvent.OnEnable, nil, skipShowAni)
    uiMediator:TriggerAllAnim(FpAnimTriggerEvent.OnShow, nil, skipShowAni)
end

---@private
function UIMediatorCommonProcessor:RefreshBlockStatus()
    if g_Game.UIManager:HaveDisableGestureUIMediator() then
        if not self._blockHandle then
            self._blockHandle = g_Game.GestureManager:SetBlockAddRef()
        end
    elseif self._blockHandle then
        self._blockHandle:UnRef()
        self._blockHandle = nil
    end
end

---@param uiMediator CS.DragonReborn.UI.UIMediator
function UIMediatorCommonProcessor:PreProcessOnClose(uiMediator)
    local luaUiMeidator = uiMediator.LogicObject
    if luaUiMeidator then
        luaUiMeidator:StopAllTimers()
    end
end

return UIMediatorCommonProcessor