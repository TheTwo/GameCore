---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by shoufeng.zhang.
--- DateTime: 2022/5/16 17:10
---
local BaseUIComponent = require('BaseUIComponent')
local ModuleRefer = require('ModuleRefer')
local Delegate = require('Delegate')
local DBEntityPath = require('DBEntityPath')
local FpAnimTriggerEvent = require('FpAnimTriggerEvent')
local Utils = require('Utils')
local ConfigRefer = require("ConfigRefer")
local UIMediatorNames = require("UIMediatorNames")
---@class CurrencyComponent : BaseUIMediator
local CurrencyComponent = class("CurrencyComponent",BaseUIComponent)
local EventConst = require("EventConst")

---@class CurrencyComponentData
---@field inSeExplorerMode boolean

local RES_WIDTH = {
    210,
    272,
    408
}

---@protected
function CurrencyComponent:ctor(...)
    BaseUIComponent.ctor(self, ...)
    self._inSeExplorerMode = false
end

function CurrencyComponent:OnCreate()
    self.btnSetting = self:Button('p_btn_setting', Delegate.GetOrCreate(self, self.OnBtnSettingClicked))
    self.compChildCapsule1 = self:LuaBaseComponent('child_btn_capsule_1')
    self.compChildCapsule2 = self:LuaBaseComponent('child_btn_capsule_2')
    self.tableviewproTableResources = self:TableViewPro('p_table_resources')
    self.btnRoot = self:Button('p_btn_content', Delegate.GetOrCreate(self, self.OnBtnSelfClicked))
    self.btnTips = self:Button('p_btn_open', Delegate.GetOrCreate(self, self.OnBtnTipsClicked))
    self.btnTipsClose = self:Button('p_btn_info_close', Delegate.GetOrCreate(self, self.OnBtnTipsCloseClicked))
    self.tipsGo = self:GameObject('p_tip_info')
    self.tipsClickToOpen = self:GameObject('p_icon_arrow_open')
    self.tipsClickToClose = self:GameObject('p_icon_arrow_close')
    self.tableCoins = self:TableViewPro('p_table_coin')
    self.aniTrigger = self:AnimTrigger('Trigger_tips')
    self.showAll = false
    self.isTipsOpen = false
    self.lastCapacity = {}
end

function CurrencyComponent:OnBtnSettingClicked()
    if self._inSeExplorerMode then return end
    g_Game.UIManager:Open(require("UIMediatorNames").UISettingsMediator)
end

function CurrencyComponent:OnShow()
    g_Game.DatabaseManager:AddChanged(DBEntityPath.Player.PlayerWrapper2.Radar.MsgPath,Delegate.GetOrCreate(self,self.Refresh))
    g_Game.DatabaseManager:AddChanged(DBEntityPath.CastleBrief.Observer.MsgPath, Delegate.GetOrCreate(self, self.Refresh))
    g_Game.DatabaseManager:AddChanged(DBEntityPath.CastleBrief.Castle.GlobalAttr.ResCapacity.MsgPath, Delegate.GetOrCreate(self, self.Refresh))
    g_Game.DatabaseManager:AddChanged(DBEntityPath.Player.PlayerWrapper2.Currency.MsgPath,Delegate.GetOrCreate(self,self.Refresh))

    g_Game.EventManager:AddListener(EventConst.HUD_CLOSE_COIN_TIPS, Delegate.GetOrCreate(self, self.OnCloseCoinTips))

    for _, v in ConfigRefer.CityResourceType:ipairs() do
        local cfg = ConfigRefer.CityResourceType:Find(v:Id())
        for i = 1, cfg:ItemsLength() do
            local itemId = cfg:Items(i)
            ModuleRefer.InventoryModule:AddCountChangeListener(itemId, Delegate.GetOrCreate(self, self.Refresh))
        end
    end

    self:Refresh()
    self:UpdateResourceTips()
end

---@param param CurrencyComponentData
function CurrencyComponent:OnFeedData(param)
    if not param then return end
    self._inSeExplorerMode = param.inSeExplorerMode
    if self._inSeExplorerMode then
        self.isTipsOpen = false
        self:UpdateResourceTips()
    end
end

function CurrencyComponent:Refresh()
    -- 2024-04-05 不显示金条
    self.compChildCapsule1:SetVisible(false)
    -- local coinId = ConfigRefer.ConstMain:UniversalCoin()
    -- local item = ConfigRefer.Item:Find(coinId)
    -- ---@type CommonResourceBtnData
    -- local iconData = {
    --     iconName = item:SubIcon(),
    --     content = ModuleRefer.InventoryModule:GetAmountByConfigId(coinId),
    --     isShowPlus = false,
    -- }
    -- self.compChildCapsule1:FeedData(iconData)

    local coinId2 = ConfigRefer.ConstMain:UniversalCoin2()
    local item2 = ConfigRefer.Item:Find(coinId2)
    local iconData2 = {
        iconName = item2:SubIcon(),
        content = ModuleRefer.InventoryModule:GetAmountByConfigId(coinId2),
        isShowPlus = false,
    }
    self.compChildCapsule2:FeedData(iconData2)
    self.tableviewproTableResources:Clear()
    for _, v in ConfigRefer.CityResourceType:ipairs() do
        local isPlayAnim = false
        local resId = v:Id()
        if not v:ShowOnHUD() then
            goto continue
        end
        if not self.lastCapacity[resId] then
            self.lastCapacity[resId] = ModuleRefer.InventoryModule:GetResItemCapacity(resId)
        else
            local currentCapacity = ModuleRefer.InventoryModule:GetResItemCapacity(resId)
            if currentCapacity > self.lastCapacity[resId] then
                self.lastCapacity[resId] = currentCapacity
                isPlayAnim = true
            end
        end
        if self.showAll then
            local itemTypeNum = v:ItemsLength()
            self.tableviewproTableResources:AppendData(v:Id(), 1)
        else
            self.tableviewproTableResources:AppendData({id = v:Id(), isPlayAnim = isPlayAnim}, 0)
        end
        ::continue::
    end
end

function CurrencyComponent:OnBtnSelfClicked()
    if self._inSeExplorerMode then return end
    -- self.showAll = not self.showAll
    -- self:Refresh()
    ---@type ExchangeResourceMediatorParam
    local data = {}
    data.isFromHUD = true
    data.itemInfos = {}
    for _, v in ConfigRefer.CityResourceType:ipairs() do
        local resId = v:Id()
        local resItemId = v:Items(1)
        local currentCount = ModuleRefer.InventoryModule:GetResTypeCount(resId)
        local capacity = ModuleRefer.InventoryModule:GetResItemCapacity(resId)
        local itemInfo = {
            id = resItemId,
            num = capacity - currentCount,
        }
        table.insert(data.itemInfos, itemInfo)
    end
    g_Game.UIManager:Open(UIMediatorNames.ExchangeResourceMediator, data)
end

function CurrencyComponent:OnBtnTipsClicked()
    if self._inSeExplorerMode then return end
    self.isTipsOpen = not self.isTipsOpen
    self:UpdateResourceTips()
end

function CurrencyComponent:OnBtnTipsCloseClicked()
    self.isTipsOpen = false
    self:UpdateResourceTips()
end

function CurrencyComponent:OnCloseCoinTips()
    self.isTipsOpen = false
    self:UpdateResourceTips()
end

function CurrencyComponent:UpdateResourceTips()
    self.tipsClickToOpen:SetVisible(not self.isTipsOpen)
    self.tipsClickToClose:SetVisible(self.isTipsOpen)

    if self.isTipsOpen then
        self.tableCoins:Clear()
        for _, v in ConfigRefer.CurrencyInfo:ipairs() do
            if v:IsDisplay() then
                self.tableCoins:AppendData(v)
            end
        end
        self.tipsGo:SetVisible(true)
    else
        self.aniTrigger:PlayAll(FpAnimTriggerEvent.OnClose, function() self.tipsGo:SetVisible(false) end)
    end
end

function CurrencyComponent:GetResCellPos(index)
    if self.resCellPos and self.resCellPos[index] then
        return self.resCellPos[index]
    end
    local cell = self.tableviewproTableResources:GetCell(index - 1)
    if cell and Utils.IsNotNull(cell.Lua.imgIconItem1) then
        return cell.Lua.imgIconItem1.transform.position
    end
    return nil
end

function CurrencyComponent:RecordResCellPos()
    self.resCellPos = {}
    for i = 1, self.tableviewproTableResources.CellCount do
        local cell = self.tableviewproTableResources:GetCell(i - 1)
        if cell and Utils.IsNotNull(cell.Lua.imgIconItem1) then
            self.resCellPos[i] = cell.Lua.imgIconItem1.transform.position
        end
    end
end

function CurrencyComponent:RecordCoinPos()
    --- 2024-04-08 金条被干掉了 都往旁边飞吧
    self.coinPos = self.compChildCapsule2.Lua.imgIconCapsule.transform.position
end

function CurrencyComponent:RecordMoneyPos()
    self.moneyPos = self.compChildCapsule2.Lua.imgIconCapsule.transform.position
end

function CurrencyComponent:GetCoinPos()
    if self.coinPos then
        return self.coinPos
    end
    return self.compChildCapsule1.Lua.imgIconCapsule.transform.position
end

function CurrencyComponent:GetMoneyPos()
    if self.moneyPos then
        return self.moneyPos
    end
    return self.compChildCapsule2.Lua.imgIconCapsule.transform.position
end

function CurrencyComponent:OnHide()
    g_Game.DatabaseManager:RemoveChanged(DBEntityPath.Player.PlayerWrapper2.Radar.MsgPath,Delegate.GetOrCreate(self,self.Refresh))
    g_Game.DatabaseManager:RemoveChanged(DBEntityPath.CastleBrief.Observer.MsgPath, Delegate.GetOrCreate(self, self.Refresh))
    g_Game.DatabaseManager:RemoveChanged(DBEntityPath.CastleBrief.Castle.GlobalAttr.ResCapacity.MsgPath, Delegate.GetOrCreate(self, self.Refresh))
    g_Game.DatabaseManager:RemoveChanged(DBEntityPath.Player.PlayerWrapper2.Currency.MsgPath,Delegate.GetOrCreate(self,self.Refresh))

    g_Game.EventManager:RemoveListener(EventConst.HUD_CLOSE_COIN_TIPS, Delegate.GetOrCreate(self, self.OnCloseCoinTips))
    for _, v in ConfigRefer.CityResourceType:ipairs() do
        local cfg = ConfigRefer.CityResourceType:Find(v:Id())
        for i = 1, cfg:ItemsLength() do
            local itemId = cfg:Items(i)
            ModuleRefer.InventoryModule:RemoveCountChangeListener(itemId, Delegate.GetOrCreate(self, self.Refresh))
        end
    end
    self.coinId = nil
end

return CurrencyComponent
